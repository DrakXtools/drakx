#!/bin/bash

KERNEL_BOOT_PATH="kernel"

function f() { 
    v=`perl -Iperl-install -e "use modules; print qq(\\$_.o\n) foreach modules::module_of_type(\"$1\")"` 
}

ARCH=`uname -m | sed -e 's/i.86/i386/' -e 's/sparc.*/sparc/'`

f "scsi|disk" ; SCSI_DRIVERS=$v
f "net|network" ; NETWORK_DRIVERS=$v
f "scsi|cdrom" ; CD_DRIVERS=$v
f "pcmcia|network" ; PCMCIA_DRIVERS=$v

[ $ARCH == "i386" ] && FSMODULES="vfat.o fat.o"

NETWORK_MODULES="$FSMODULES $NETWORK_DRIVERS"
CDROM_MODULES="  $FSMODULES $CD_DRIVERS"
HD_MODULES="     $FSMODULES $SCSI_DRIVERS"
PCMCIA_MODULES=" $FSMODULES $PCMCIA_DRIVERS isofs.o"
LNX4WIN_MODULES="$FSMODULES loop.o isofs.o"
NOT_USEFULL_IN_STAGE1="nls_*.o parport_probe.o raid*.o serial.o smbfs.o usb-*.o"

PCMCIA_INSTALLMODULES="pcmcia_core.o tcic.o ds.o i82365.o"

if [ "$ARCH" == "i386" ]; then
    #set 640x480x16 resolution on boot.
    cp -f $KERNEL_BOOT_PATH/boot/vmlinuz* vmlinuz
    /usr/sbin/rdev -v vmlinuz 788 #785 
    cp -f vmlinuz /export/lnx4win

    rm -rf install_pcmcia_modules ; install -d install_pcmcia_modules
    install -d lnx4win/initrd/modules
else
    cp -f "$KERNEL_BOOT_PATH"/boot/vmlinux.gz .
fi
cp -f $KERNEL_BOOT_PATH/boot/System.map* System.map

rm -rf modules ; install -d modules
(cd modules ; 
    cp -f `find ../"$KERNEL_BOOT_PATH"/lib/modules/ -name "*.o"` .
    /sbin/depmod -m ../System.map -i -e *.o | grep ': ' | sed 's/\.o//g' > modules.dep
    perl -pi -e 's/((plip|ppa|imm): parport)/$1 parport_pc/' modules.dep
    ls *.o              | ../tools/build_archive modules.cz2 400000
    ls *.o              | cpio --quiet -H crc -o | bzip2 -9> modules.cpio.bz2
    ls $NETWORK_MODULES | cpio --quiet -H crc -o | gzip -9 > network_modules.cgz
    ls $CDROM_MODULES   | cpio --quiet -H crc -o | gzip -9 > cdrom_modules.cgz	
    ls $HD_MODULES      | cpio --quiet -H crc -o | gzip -9 > hd_modules.cgz     
    ls $PCMCIA_MODULES  | cpio --quiet -H crc -o | gzip -9 > pcmcia_modules.cgz
[ "$ARCH" == "i386" ] && {
    cp $PCMCIA_INSTALLMODULES ../install_pcmcia_modules/
    cp -f $LNX4WIN_MODULES modules.dep ../lnx4win/initrd/modules
}
    rm -f $NETWORK_MODULES $CDROM_MODULES $HD_MODULES $PCMCIA_MODULES $PCMCIA_INSTALLMODULES $NOT_USEFULL_IN_STAGE1 # leave in the directory non-install1 used modules
)
