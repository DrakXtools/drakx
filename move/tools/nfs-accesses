#!/usr/bin/perl

use MDK::Common;
use Getopt::Long;

my $first_file = '/usr/bin/totem';

GetOptions('no-link' => \ (my $no_link), 
	   'no-dir' => \ (my $no_dir),
	   'full-dirs=s', \ (my $full_dirs),
	   'ip=s' => \ (my $wanted_ip),
	   'first-file=s' => \$first_file,
	  );

my @skipped_dirs = (
		    '/usr/share/fonts', 
		    '/lib/modules/2.4.22-21mdk',
		    '/usr/X11R6/lib/modules/extensions',
		    '/usr/X11R6/lib/X11/fonts',
		    '/usr/lib/kbd/keymaps',
		    '/usr/share/locale',
		    '/etc/skel',
		    );

my $skipped_dirs = '/tmp/live_tree(' . join('|', map { quotemeta } @skipped_dirs) . ')/';
if ($full_dirs) {
    my @l = chomp_(map { MDK::Common::File::cat_or_die($_) } split(' ', $full_dirs));
    $full_dirs = '/tmp/live_tree(' . join('|', map { quotemeta } @l) . ')/';
}

open(my $F, "tac /var/log/kernel/warnings |");

my @l;
while (<$F>) {
    my ($ip, $rfile) = /kernel: nfsd \((.*?)\): (.*)/ or next; 

    if ($wanted_ip) {
	$wanted_ip eq $ip or next;
    } else {
	warn "choosing $ip\n";
	$wanted_ip = $ip;
    }
    my $file = join('/', '', reverse split('/', $rfile));

    last if $file =~ m!/tmp/live_tree/move/(devices|symlinks)!;

    if ($file !~ /^$skipped_dirs/) {
	if (-l $file ? !$no_link : -d $file ? !$no_dir : 1) {
	    my $s = $full_dirs && $file =~ /^$full_dirs/ ? "/tmp/live_tree$1" : $file;
	    unshift @l, $s;
	}
    }
    last if $file eq "/tmp/live_tree$first_file" || $rfile eq $first_file;
}

print "$_\n" foreach sort(uniq(@l));
