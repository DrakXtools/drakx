#!/usr/bin/perl

use lib qw(/usr/lib/libDrakX);

use standalone;     #- warning, standalone must be loaded very first, for 'explanations'

use common;
use interactive;
use mouse;
use c;

local $_ = join '', @ARGV;

/-h/ and die "usage: draksec [--expert]\n";

$::expert = /-expert/ || cat_("/etc/sysconfig/system") =~ /^CLASS="?expert/m; #"
$::isEmbedded = ($::XID, $::CCPID) = "@ARGV" =~ /--embedded (\w+) (\w+)/;

my $in = 'interactive'->vnew('su', 'security');

begin:
$::isEmbedded and kill USR2, $::CCPID;


my $security =
  cat_("/etc/profile.d/msec.sh") =~ /export SECURE_LEVEL=(\d+)/ ? $1 :
  $ENV{SECURE_LEVEL} || 2;
my $libsafe = any::config_libsafe('');

if (any::choose_security_level($in, \$security, \$libsafe)) {

    any::config_libsafe('', $libsafe);

    my $w = $in->wait_message('', _("Setting security level"));
    $in->suspend;
    $ENV{LILO_PASSWORD} = ''; # make it non interactive
    system "/usr/sbin/msec", $security;
    $in->resume;
}

!$::isEmbedded ? $in->exit(0) : kill(USR1, $::CCPID);
goto begin;
