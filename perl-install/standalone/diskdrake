#!/usr/bin/perl

# DiskDrake
# Copyright (C) 1999 MandrakeSoft (pixel@mandrakesoft.com)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.

# DiskDrake uses resize_fat which is a perl rewrite of the work of Andrew
# Clausen (libresize).
# DiskDrake is also based upon the libfdisk and the install from Red Hat Software


use lib qw(/usr/lib/libDrakX);

use standalone;     #- warning, standalone must be loaded very first, for 'explanations'

use common;
use diskdrake_interactive;
use interactive;
use detect_devices;
use fsedit;
use fs;
use log;
use c;


$::isEmbedded = ($::XID, $::CCPID) = "@ARGV" =~ /--embedded (\w+) (\w+)/;
if ($::isEmbedded) {
  print "EMBED\n";
  print "parent XID\t$::XID\n";
  print "mcc pid\t$::CCPID\n";
}

local $_ = join '', @ARGV;

/-h/ and die "usage: diskdrake [--expert] [--testing] [--fileshare]\n";

$::expert = /-expert/;
$::testing = /-testing/;
my $fileshare = /-fileshare/;

if ($>) {
    $ENV{PATH} = "/sbin:/usr/sbin:$ENV{PATH}";
}


my $in = 'interactive'->vnew('su');

if ($fileshare) {
    any::fileshare_config($in);
    $in->exit(0);
}

my ($all_hds) =
    catch_cdie { fsedit::hds([ detect_devices::hds() ], {}) }
    sub {
	my $err = formatError($@);
	if ($err =~ /overlapping/) {
	    $in->ask_warn('', $err);
	    1;
	} else {
	    !$in->ask_okcancel(_("Error"),
[_("I can't read your partition table, it's too corrupted for me :(
I'll try to go on blanking bad partitions"), $err]);
        }
    };

$SIG{__DIE__} = sub { my $m = chomp_($_[0]); log::l("ERROR: $m") };
my $fstab = [ fsedit::get_all_fstab($all_hds) ];

fs::get_raw_hds('', $all_hds);

fs::merge_info_from_fstab([ fsedit::get_really_all_fstab($all_hds) ]);
fs::merge_info_from_mtab([ fsedit::get_really_all_fstab($all_hds) ]);

if ($ENV{TEST_DEFAULT_OPTIONS}) {
    fs::set_all_default_options($all_hds);
    fs::set_removable_mntpoints($all_hds);
}
diskdrake_interactive::main($in, $all_hds);

$in->exit(0);
